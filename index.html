<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品数据库智能查询 (响应式版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 您的所有样式都非常棒，无需修改，予以保留 */
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background-color: #f8fafc; }
        .table-container { max-height: 65vh; overflow-y: auto; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        thead th { position: sticky; top: 0; background-color: #f1f5f9; z-index: 10; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        @media (max-width: 767px) {
            .table-container { max-height: none; overflow-y: visible; }
            .responsive-table thead { display: none; }
            .responsive-table tbody, .responsive-table tr, .responsive-table td { display: block; width: 100%; }
            .responsive-table tr { margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid #f1f5f9; }
            .responsive-table tr:last-child { margin-bottom: 0; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; text-align: left; margin-right: 1rem; color: #475569; flex-shrink: 0; }
            .responsive-table td.action-cell { justify-content: center; padding: 1rem; background-color: #f8fafc; }
            .responsive-table td.action-cell::before { display: none; }
            .responsive-table .truncate { white-space: normal; }
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div id="appContainer">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">产品数据库智能查询</h1>
                <p class="mt-2 text-slate-500">向Gemini提问，它会帮您从数据库中筛选数据！</p>
            </header>

            <!-- 搜索框和按钮的HTML结构保持不变 -->
            <div class="mb-6 max-w-2xl mx-auto">
                <div class="relative">
                    <input type="text" id="searchInput"
                           class="block w-full pl-4 pr-28 py-3 border border-slate-300 rounded-xl leading-5 bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-1 focus:ring-sky-500 focus:border-sky-500 sm:text-sm shadow-sm transition duration-150 ease-in-out">
                    <button id="searchButton" class="absolute inset-y-0 right-0 flex items-center px-4 font-semibold text-white bg-sky-500 hover:bg-sky-600 rounded-r-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        <span class="ml-2 hidden sm:inline">查询</span>
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center items-center mb-4 min-h-9 space-y-2 sm:space-y-0 sm:space-x-4">
                <div id="stats" class="text-sm text-slate-600"></div>
                <button id="exportButton" class="hidden items-center px-3 py-1.5 text-sm font-semibold text-white bg-green-500 hover:bg-green-600 rounded-lg shadow-sm disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span id="exportButtonText">导出CSV</span>
                </button>
            </div>

            <!-- 表格和消息中心的HTML结构保持不变 -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="table-container">
                    <table class="w-full table-fixed divide-y divide-slate-200 responsive-table">
                        <thead id="tableHeader" class="bg-slate-100"></thead>
                        <tbody id="productTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                    </table>
                </div>
                 <div id="messageCenter" class="text-center py-12 px-6">
                     <svg class="mx-auto h-12 w-12 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                         <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                     </svg>
                     <h3 id="messageTitle" class="mt-2 text-sm font-semibold text-slate-600">准备就绪</h3>
                     <p id="messageText" class="mt-1 text-sm text-slate-400">请输入您想查询的内容。</p>
                     <div id="loader" class="loader mx-auto hidden mt-4"></div>
                 </div>
            </div>
        </div>
    </div>

    <!-- 详情模态框的HTML结构保持不变 -->
    <div id="productModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[60vh] overflow-y-auto transform scale-95">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center z-10">
                <h3 id="modalTitle" class="text-lg font-bold text-slate-800">产品详情</h3>
                <button id="closeModalButton" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="modalBody" class="p-6"></div>
        </div>
    </div>

    <!-- 图片模态框的HTML结构保持不变 -->
    <div id="imageModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="relative bg-white rounded-lg shadow-xl max-w-4xl max-h-[80vh]">
            <button id="closeImageModalButton" class="absolute -top-3 -right-3 text-white bg-gray-800 rounded-full p-1 hover:bg-gray-600 z-20">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <img id="modalImage" src="" alt="产品图片" class="object-contain max-w-full max-h-[80vh] rounded-lg">
        </div>
    </div>


    <script>
        const BASE_API_URL = "https://product-search-api-bigquery-831320827787.us-central1.run.app"; // 请务必替换为您的实际URL
        const SEARCH_API_ENDPOINT = `${BASE_API_URL}/search`;
        const DETAILS_API_ENDPOINT = `${BASE_API_URL}/details`;

        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('productTableBody');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const statsDiv = document.getElementById('stats');
        const messageCenter = document.getElementById('messageCenter');
        const loader = document.getElementById('loader');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const exportButton = document.getElementById('exportButton');
        const exportButtonText = document.getElementById('exportButtonText');
        const productModal = document.getElementById('productModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModalButton = document.getElementById('closeModalButton');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeImageModalButton = document.getElementById('closeImageModalButton');
        
        let currentProducts = [];

        function renderTable(products, displayColumns) {
            currentProducts = products;
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            if (!products || products.length === 0) {
                messageCenter.classList.remove('hidden');
                loader.classList.add('hidden');
                messageTitle.textContent = '未能找到结果';
                messageText.textContent = '请尝试使用其他关键词进行搜索。';
                exportButton.classList.add('hidden');
                statsDiv.textContent = '';
                return;
            }
            
            messageCenter.classList.add('hidden');
            exportButton.classList.remove('hidden');

            const headerRow = document.createElement('tr');
            displayColumns.forEach(colName => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider';
                th.textContent = colName;
                headerRow.appendChild(th);
            });
            
            const actionTh = document.createElement('th');
            actionTh.className = 'px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider';
            actionTh.textContent = '操作';
            headerRow.appendChild(actionTh);
            tableHeader.appendChild(headerRow);

            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition duration-150 ease-in-out';
                
                displayColumns.forEach(colName => {
                    const td = document.createElement('td');
                    td.setAttribute('data-label', colName); 
                    td.className = 'px-4 py-4 text-sm text-slate-600 break-words'; 
                    const cellValue = (product[colName] === null || product[colName] === undefined) ? '' : product[colName];
                    
                    // --- 【核心修改】: 添加特殊逻辑来渲染可点击的产品型号 ---
                    if (colName === '产品型号') {
                        const imageUrl = product['产品缩略图URL'];
                        if (imageUrl) {
                            // 如果有URL，则创建链接
                            td.innerHTML = `<a href="#" data-image-url="${imageUrl}" class="view-image-btn text-sky-600 hover:text-sky-800 hover:underline">${cellValue}</a>`;
                        } else {
                            // 如果没有URL，则只显示文本
                            td.textContent = cellValue;
                        }
                    } else {
                        // 其他列的渲染逻辑保持不变
                        let displayValue = cellValue;
                        if (['成本价', '代发价', '京东零售价'].includes(colName) && cellValue) {
                           displayValue = `¥${cellValue}`;
                        }
                        td.textContent = displayValue;
                        td.title = displayValue; // 为长文本提供悬浮提示
                    }
                    
                    row.appendChild(td);
                });

                const actionTd = document.createElement('td');
                actionTd.setAttribute('data-label', '操作');
                actionTd.classList.add('action-cell');
                actionTd.className += ' px-4 py-4 whitespace-nowrap text-sm text-center';
                
                const productId = product['序号'];
                actionTd.innerHTML = `<button data-id="${productId}" class="view-details-btn text-sky-600 hover:text-sky-800 font-semibold py-2 px-4 rounded-md w-full bg-white border border-slate-300 hover:bg-slate-50 transition-colors">查看详情</button>`;
                row.appendChild(actionTd);
                tableBody.appendChild(row);
            });
            statsDiv.textContent = `查询到 ${products.length} 条相关记录。`;
        }
        
        function showProductDetails(product) {
            modalTitle.textContent = `${product['品牌'] || ''} - ${product['产品型号'] || '产品详情'}`;
            let detailsHtml = '<dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">';

            const allProductKeys = Object.keys(product);
            const preferredOrder = [ '品牌', '产品型号', '产品名称', '所属事业部', '大类', '小类', '核心参数', '成本价', '代发价', '京东零售价', '库存' ];
            const lastOrder = ['京东链接', '3C图片', '质检图片', '图片资料包'];
            const excludedKeys = [...preferredOrder, ...lastOrder];
            const middleOrder = allProductKeys.filter(key => !excludedKeys.includes(key)).sort();
            const finalDisplayOrder = [...preferredOrder, ...middleOrder, ...lastOrder];

            const createDetailItem = (key, value) => {
                if (value === null || value === undefined || value === '') return '';
                const valueStr = String(value);
                let valueHtml;
                 if ((key.includes('图片') || key.includes('URL')) && (valueStr.startsWith('http'))) {
                    valueHtml = `<a href="#" data-image-url="${valueStr}" class="view-image-btn text-sky-600 hover:text-sky-800 hover:underline break-all">${valueStr}</a>`;
                } else if (valueStr.startsWith('http')) {
                    valueHtml = `<a href="${valueStr}" target="_blank" rel="noopener noreferrer" class="text-sky-600 hover:text-sky-800 hover:underline break-all">${valueStr}</a>`;
                } else {
                    valueHtml = `<span class="break-all">${valueStr}</span>`;
                }
                return `<div class="bg-slate-50 p-3 rounded-lg"><dt class="text-sm font-medium text-gray-500">${key}</dt><dd class="mt-1 text-sm text-gray-900">${valueHtml}</dd></div>`;
            };

            finalDisplayOrder.forEach(key => {
                if (product.hasOwnProperty(key)) {
                    detailsHtml += createDetailItem(key, product[key]);
                }
            });

            detailsHtml += '</dl>';
            modalBody.innerHTML = detailsHtml;
            productModal.classList.remove('opacity-0', 'pointer-events-none');
            productModal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function hideProductDetails() {
            productModal.classList.add('opacity-0', 'pointer-events-none');
            productModal.querySelector('.modal-content').classList.add('scale-95');
        }

        function showImageModal(imageUrl) {
            modalImage.src = imageUrl;
            imageModal.classList.remove('opacity-0', 'pointer-events-none');
        }

        function hideImageModal() {
            imageModal.classList.add('opacity-0', 'pointer-events-none');
            modalImage.src = '';
        }

        async function fetchAndShowDetails(productId) {
            modalTitle.textContent = '正在加载详情...';
            modalBody.innerHTML = '<div class="loader mx-auto my-8"></div>';
            productModal.classList.remove('opacity-0', 'pointer-events-none');
            productModal.querySelector('.modal-content').classList.remove('scale-95');

            try {
                const response = await fetch(`${DETAILS_API_ENDPOINT}?id=${productId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `服务器错误: ${response.status}`);
                }
                const productDetails = await response.json();
                showProductDetails(productDetails);
            } catch (error) {
                modalBody.innerHTML = `<p class="text-red-500 text-center p-4">加载详情失败: ${error.message}</p>`;
            }
        }

        async function performSearch() {
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) {
                statsDiv.textContent = '请输入查询内容！';
                return;
            }

            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            statsDiv.textContent = '';
            exportButton.classList.add('hidden');
            messageCenter.classList.remove('hidden');
            loader.classList.remove('hidden');
            messageTitle.textContent = '正在查询，请稍候...';
            messageText.textContent = 'Gemini正在为您生成SQL并查询数据库。';

            try {
                const response = await fetch(SEARCH_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: searchTerm }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `服务器错误: ${response.status}`);
                }
                const data = await response.json();
                renderTable(data.products, data.display_columns);
            } catch (error) {
                loader.classList.add('hidden');
                messageTitle.textContent = '查询失败';
                messageText.textContent = error.message;
            }
        }
        
        function escapeCSVCell(cell) {
            if (cell === null || cell === undefined) return '';
            const cellStr = String(cell);
            if (cellStr.search(/("|,|\n)/g) >= 0) {
                return `"${cellStr.replace(/"/g, '""')}"`;
            }
            return cellStr;
        }

        async function exportToCSV() {
            if (currentProducts.length === 0) {
                alert('没有可导出的数据。');
                return;
            }
            
            exportButton.disabled = true;
            exportButtonText.textContent = '准备数据...';

            try {
                const fetchPromises = currentProducts.map(product =>
                    fetch(`${DETAILS_API_ENDPOINT}?id=${product['序号']}`).then(res => res.ok ? res.json() : null)
                );
                const detailedProducts = (await Promise.all(fetchPromises)).filter(p => p !== null);

                if (detailedProducts.length === 0) throw new Error("未能获取用于导出的详细数据。");
                
                const headers = Object.keys(detailedProducts[0]);
                const csvRows = [headers.join(',')];
                detailedProducts.forEach(product => {
                    csvRows.push(headers.map(header => escapeCSVCell(product[header])).join(','));
                });

                const csvString = '\uFEFF' + csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                link.href = URL.createObjectURL(blob);
                link.download = `产品查询结果-${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                alert(`导出失败: ${error.message}`);
            } finally {
                exportButton.disabled = false;
                exportButtonText.textContent = '导出CSV';
            }
        }

        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') performSearch(); });
        exportButton.addEventListener('click', exportToCSV);

        closeModalButton.addEventListener('click', hideProductDetails);
        productModal.addEventListener('click', (event) => { if (event.target === productModal) hideProductDetails(); });

        closeImageModalButton.addEventListener('click', hideImageModal);
        imageModal.addEventListener('click', (event) => { if (event.target === imageModal) hideImageModal(); });

        document.body.addEventListener('click', (event) => {
            const detailsButton = event.target.closest('.view-details-btn');
            if (detailsButton) {
                event.preventDefault();
                const productId = detailsButton.dataset.id;
                fetchAndShowDetails(productId);
                return;
            }

            const imageButton = event.target.closest('.view-image-btn');
            if (imageButton) {
                event.preventDefault();
                const imageUrl = imageButton.dataset.imageUrl;
                showImageModal(imageUrl);
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            searchInput.placeholder = "例如: 美的最便宜的是哪个";
        });
    </script>
</body>
</html>
