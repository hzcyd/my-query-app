<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浙江太合贸易有限公司</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

<style>
    body { 
        font-family: 'Inter', 'Noto Sans SC', sans-serif; 
        background-color: #f8fafc; 
    }
    .table-container { 
        max-height: 65vh; 
        overflow-y: auto; 
    }
    .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
    .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
    .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
    thead th { 
        position: sticky; 
        top: 0; 
        background-color: #f1f5f9; 
        z-index: 10; 
    }
    .loader { 
        border: 4px solid #f3f3f3; 
        border-radius: 50%; 
        border-top: 4px solid #3498db; 
        width: 40px; 
        height: 40px; 
        animation: spin 2s linear infinite; 
    }
    @keyframes spin { 
        0% { transform: rotate(0deg); } 
        100% { transform: rotate(360deg); } 
    }
    .modal { transition: opacity 0.25s ease; }
    .modal-content { transition: transform 0.25s ease; }
    
    /* 文本截断 & 展开按钮 */
    .line-clamp-2 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
    }
    .line-clamp-none { -webkit-line-clamp: unset; }

    .copy-toast {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    /* === 统一按钮风格 === */
    .btn-action {
        flex: 1;
        min-width: 80px;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-image {
        background-color: #f1f5f9;
        color: #1e293b;
        border: 1px solid #cbd5e1;
    }
    .btn-image:hover {
        background-color: #e2e8f0;
    }

    .btn-details {
        background-color: #0284c7;
        color: white;
        border: 1px solid #0284c7;
    }
    .btn-details:hover {
        background-color: #0369a1;
    }

    /* === 移动端两列卡片布局 === */
    @media (max-width: 767px) {
        .table-container { max-height: none; overflow: visible; }
        .responsive-table { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 0.75rem; 
        }
        .responsive-table thead { display: none; }
        .responsive-table tbody { display: contents; }
        .responsive-table tr {
            display: block;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .responsive-table td {
            display: block;
            font-size: 0.75rem;
            color: #334155;
            padding: 0.15rem 0;
        }
        .responsive-table td strong {
            display: inline-block;
            min-width: 4em;
            color: #475569;
        }
        .card-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
            gap: 0.5rem;
        }
        /* 移动端按钮宽度自适应修复 */
        .btn-action {
            min-width: auto;
            flex-shrink: 1; /* 允许按钮在必要时收缩 */
        }
    }
</style>

</head>
<body class="antialiased text-slate-700">

    <!-- 登录模态框 -->
    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-2">欢迎回来</h2>
            <p class="text-center text-slate-500 mb-6">请输入您的凭证以继续</p>
            <form id="loginForm">
                 <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-slate-700 mb-1">账号</label>
                    <input type="text" id="username" name="username" required
                           class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-slate-700 mb-1">密码</label>
                    <input type="password" id="password" name="password" required
                         class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                <button type="submit" id="loginButton"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:bg-slate-400">
                    <span id="loginButtonText">登录</span>
                    <div id="loginLoader" class="loader !w-5 !h-5 !border-2 !border-t-white hidden ml-2"></div>
                </button>
                <p id="loginError" class="text-red-500 text-sm mt-4 text-center h-5"></p>
            </form>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div id="appContainer" class="hidden">
        <div class="container mx-auto p-8 sm:p-6 lg:p-8">
	<header class="mb-8 flex justify-between items-center relative">
    	<!-- 左侧Logo容器 -->
    	<div class="absolute left-0">
        	 <img src="https://picture-1372068725.cos.ap-shanghai.myqcloud.com/%E5%A4%AA%E5%90%88%20logo.png" alt="公司Logo" class="h-20">
   	 </div>

   	 <!-- 中间标题容器 -->
   	 <div class="flex-grow text-center">
    	    <h1 class="text-2xl sm:text-4xl font-bold text-slate-800">浙江太合产品库</h1>
   	 </div>

   	 <!-- 右侧登出按钮 -->
   	 <div class="absolute right-0">
    	    <button id="logoutButton" class="flex-shrink-0 text-sm text-sky-600 font-semibold py-2 px-3 rounded-md transition-colors border border-sky-500 hover:bg-sky-50">
    	        登出
    	    </button>
   	 </div>
	</header>
            
            <div class="mb-4 max-w-2xl mx-auto">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="例如: 美的电饭煲，代发价100-200"
                         class="block w-full pl-4 pr-28 py-3 border border-slate-300 rounded-xl leading-5 bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-1 focus:ring-sky-500 focus:border-sky-500 sm:text-sm shadow-sm transition duration-150 ease-in-out">
                    <button id="searchButton" class="absolute inset-y-0 right-0 flex items-center px-4 font-semibold text-white bg-sky-500 hover:bg-sky-600 rounded-r-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        <span class="ml-2 hidden sm:inline">查询</span>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-4 min-h-9">
                <div id="stats" class="text-sm text-slate-600"></div>
                <div class="flex items-center space-x-2">
                    <button id="sortButton" class="hidden items-center px-2.5 py-1 text-xs font-semibold text-slate-600 bg-white border border-slate-300 hover:bg-slate-50 rounded-md shadow-sm">
                        <svg id="sortIcon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h13M3 8h9M3 12h9m-9 4h13m0-4l3 3m0 0l3-3m-3 3v-8" />
                        </svg>
                        <span id="sortButtonText">按价格排序</span>
                    </button>
                    <button id="exportButton" class="hidden items-center px-2.5 py-1 text-xs font-semibold text-white bg-green-500 hover:bg-green-600 rounded-md shadow-sm disabled:bg-slate-300 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span id="exportButtonText">导出CSV</span>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="table-container">
                    <table class="w-full table-fixed divide-y divide-slate-200 responsive-table">
                        <thead id="tableHeader" class="bg-slate-100"></thead>
                        <tbody id="productTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                    </table>
                </div>
                 <div id="messageCenter" class="text-center py-12 px-6">
                     <svg class="mx-auto h-12 w-12 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                         <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                     </svg>
                     <h3 id="messageTitle" class="mt-2 text-sm font-semibold text-slate-600">准备就绪</h3>
                     <p id="messageText" class="mt-1 text-sm text-slate-400">请输入您想查询的内容。</p>
                     <div id="loader" class="loader mx-auto hidden mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="productModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto transform scale-95">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center z-10">
                <h3 id="modalTitle" class="text-lg font-bold text-slate-800">产品详情</h3>
                <button id="closeModalButton" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="modalBody" class="p-6"></div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="relative bg-white rounded-lg shadow-xl max-w-4xl max-h-[80vh]">
            <button id="closeImageModalButton" class="absolute -top-3 -right-3 text-white bg-gray-800 rounded-full p-1 hover:bg-gray-600 z-20">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <img id="modalImage" src="" alt="产品图片" class="object-contain max-w-full max-h-[80vh] rounded-lg">
        </div>
    </div>
    
    <!-- 新增：复制成功提示 -->
    <div id="copyToast" class="copy-toast fixed bottom-5 right-5 bg-slate-800 text-white text-sm py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        链接已复制到剪贴板!
    </div>


    <script>
        // --- API 端点配置 ---
        const BASE_API_URL = "https://product-search-api-bigquery-831320827787.us-central1.run.app"; // 请务必替换为您的实际URL
        const LOGIN_API_ENDPOINT = `${BASE_API_URL}/login`;
        const SEARCH_API_ENDPOINT = `${BASE_API_URL}/search`;
        const DETAILS_API_ENDPOINT = `${BASE_API_URL}/details`;

        const VISIBLE_COLUMNS = [
            '品牌', '小类', '产品型号', '开单价', '代发价', '零售价', 
            '核心参数', '库存', '主仓库'
        ];

        const DB_COLUMN_ORDER = [
            '序号', '品牌', '所属事业部', '大类', '小类', '产品型号', '产品卖点', '核心参数',
            '渠道属性', '条形码', '产品颜色', '容量', '深度', '宽度', '高度', '包装尺寸', '包装体积', '毛重',
            '箱规', '功率', '能效等级', '库存', '开单价', '代发价', '零售价', '毛利空间',
            '评论数', '京东链接', '是否自营', '主仓库', '是否退市', '3C图片', '质检图片', 
            '产品缩略图URL', '图片资料包', '京东链接'
        ];
        
        // =========================================================================
        //  【核心修改区域】只让“产品卖点”拥有展开/收起功能
        // =========================================================================
        const LONG_TEXT_FIELDS = ['产品卖点']; 
        const URL_FIELDS = ['3C图片', '质检图片', '产品缩略图URL', '图片资料包', '京东链接'];

        // --- DOM 元素获取 ---
        const loginModal = document.getElementById('loginModal');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const loginButtonText = document.getElementById('loginButtonText');
        const loginLoader = document.getElementById('loginLoader');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('productTableBody');
        const searchButton = document.getElementById('searchButton');
        const searchInput = document.getElementById('searchInput');
        const statsDiv = document.getElementById('stats');
        const messageCenter = document.getElementById('messageCenter');
        const loader = document.getElementById('loader');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const exportButton = document.getElementById('exportButton');
        const exportButtonText = document.getElementById('exportButtonText');
        const productModal = document.getElementById('productModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModalButton = document.getElementById('closeModalButton');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeImageModalButton = document.getElementById('closeImageModalButton');
        const sortButton = document.getElementById('sortButton');
        const sortButtonText = document.getElementById('sortButtonText');
        const sortIcon = document.getElementById('sortIcon');
        const copyToast = document.getElementById('copyToast');
        
        // --- 全局状态变量 ---
        let originalProducts = [];
        let currentDisplayProducts = [];
        let sortState = 'default';

        // --- 认证核心函数 ---
        function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';
            loginButton.disabled = true;
            loginButtonText.classList.add('hidden');
            loginLoader.classList.remove('hidden');

            const username = loginForm.username.value;
            const password = loginForm.password.value;
            fetch(LOGIN_API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password }),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || '登录失败') });
                }
                return response.json();
            })
             .then(data => {
                try {
                    if (!data.token) {
                        throw new Error("服务器未返回有效的认证令牌。");
                    }
                    sessionStorage.setItem('authToken', data.token);
                    showApp();
                } catch (e) {
                    console.error("在处理登录成功逻辑时出错:", e);
                    loginError.textContent = `客户端错误: ${e.message}`;
                }
            })
            .catch(error => {
                loginError.textContent = error.message;
            })
            .finally(() => {
                loginButton.disabled = false;
                loginButtonText.classList.remove('hidden');
                loginLoader.classList.add('hidden');
            });
        }

        function handleLogout() {
            sessionStorage.removeItem('authToken');
            location.reload();
        }
        
        function showApp() {
            loginModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        function showLogin() {
            appContainer.classList.add('hidden');
            loginModal.classList.remove('hidden');
        }

        async function fetchWithAuth(url, options = {}) {
            const token = sessionStorage.getItem('authToken');
            if (!token) {
                showLogin();
                throw new Error("认证失效，请重新登录。");
            }
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) {
                handleLogout();
                throw new Error("认证已过期，请重新登录。");
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `服务器错误: ${response.status}`);
            }
            return response.json();
        }

        // --- 核心业务函数 ---
        async function performSearch() {
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) {
                statsDiv.textContent = '请输入查询内容！';
                statsDiv.classList.add('text-red-500');
                setTimeout(() => { statsDiv.textContent = ''; statsDiv.classList.remove('text-red-500'); }, 3000);
                return;
            }
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            statsDiv.textContent = '';
            exportButton.classList.add('hidden');
            sortButton.classList.add('hidden');
            messageCenter.classList.remove('hidden');
            loader.classList.remove('hidden');
            messageTitle.textContent = '正在查询，请稍候...';
            messageText.textContent = 'AI正在为您生成SQL并查询数据库。';
            try {
                const data = await fetchWithAuth(SEARCH_API_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify({ query: searchTerm }),
                });
                originalProducts = data.products; 
                currentDisplayProducts = [...originalProducts]; 
                sortState = 'default'; 
                updateSortButtonUI(); 
                renderTable(currentDisplayProducts, VISIBLE_COLUMNS);
            } catch (error) {
                loader.classList.add('hidden');
                messageTitle.textContent = '查询失败';
                messageText.textContent = error.message;
            }
        }
        
        async function fetchAndShowDetails(productId) {
            modalBody.innerHTML = '<div class="flex justify-center items-center p-8"><div class="loader"></div></div>';
            showProductDetails({ '品牌': '正在加载', '产品型号': '详情...' });
            try {
                const productDetails = await fetchWithAuth(`${DETAILS_API_ENDPOINT}?id=${productId}`);
                showProductDetails(productDetails);
            } catch (error) {
                modalBody.innerHTML = `<p class="text-red-500 text-center p-4">加载详情失败: ${error.message}</p>`;
            }
        }
        
        async function exportToCSV() {
            if (currentDisplayProducts.length === 0) { return; }
            exportButton.disabled = true;
            exportButtonText.textContent = `准备数据 (0/${currentDisplayProducts.length})...`;
            try {
                let count = 0;
                const fetchPromises = currentDisplayProducts.map(product =>
                    fetchWithAuth(`${DETAILS_API_ENDPOINT}?id=${product['序号']}`)
                        .then(data => {
                            count++;
                            exportButtonText.textContent = `准备数据 (${count}/${currentDisplayProducts.length})...`;
                            return data;
                        })
                        .catch(err => { console.error(`Failed to fetch details for ID ${product['序号']}:`, err); return null; })
                );
                const detailedProducts = (await Promise.all(fetchPromises)).filter(p => p !== null);

                if (detailedProducts.length === 0) {
                    throw new Error("未能获取任何产品的详细数据以供导出。");
                }
                
                const headers = DB_COLUMN_ORDER.filter(h => detailedProducts[0].hasOwnProperty(h));
                const csvRows = [headers.join(',')];

                detailedProducts.forEach(product => {
                    const row = headers.map(header => escapeCSVCell(product[header]));
                    csvRows.push(row.join(','));
                });
                const csvString = '\uFEFF' + csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                link.setAttribute('download', `产品查询结果-${timestamp}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                alert(`导出失败: ${error.message}`);
            } finally {
                exportButton.disabled = false;
                exportButtonText.textContent = '导出CSV';
            }
        }
        
        function handleSort() {
            if (originalProducts.length === 0) return;

            if (sortState === 'default') {
                sortState = 'asc';
            } else if (sortState === 'asc') {
                sortState = 'desc';
            } else {
                sortState = 'default';
            }
            
            if (sortState === 'default') {
                currentDisplayProducts = [...originalProducts];
            } else {
                currentDisplayProducts.sort((a, b) => {
                    const priceA = parseFloat(a['代发价']) || 0;
                    const priceB = parseFloat(b['代发价']) || 0;
                    return sortState === 'asc' ? priceA - priceB : priceB - priceA;
                });
            }

            updateSortButtonUI();
            renderTable(currentDisplayProducts, VISIBLE_COLUMNS);
        }

        function updateSortButtonUI() {
            if (sortState === 'asc') {
                sortButtonText.textContent = '价格升序';
                sortIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />`;
            } else if (sortState === 'desc') {
                sortButtonText.textContent = '价格降序';
                sortIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3 4h13M3 8h9m-9 4h6m4 0l4 4m0 0l4-4m-4 4V4" />`;
            } else {
                sortButtonText.textContent = '按价格排序';
                sortIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3 4h13M3 8h9M3 12h9m-9 4h13m0-4l3 3m0 0l3-3m-3 3v-8" />`;
            }
        }
        
        // --- 渲染与显示函数 ---
function renderTable(products, displayColumns) {
    tableHeader.innerHTML = '';
    tableBody.innerHTML = '';

    if (!products || products.length === 0) {
        messageCenter.classList.remove('hidden');
        loader?.classList.add('hidden');
        messageTitle.textContent = '未能找到结果';
        messageText.textContent = '请尝试使用其他关键词进行搜索。';
        exportButton?.classList.add('hidden');
        sortButton?.classList.add('hidden');
        return;
    }

    messageCenter.classList.add('hidden');
    exportButton?.classList.remove('hidden');
    sortButton?.classList.remove('hidden');

    const isMobile = window.innerWidth < 768;

    if (!isMobile) {
        // === 桌面端表格头部 ===
        const headerRow = document.createElement('tr');
        displayColumns.forEach(colName => {
            const th = document.createElement('th');
            th.className = 'px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider';
            th.textContent = colName;
            headerRow.appendChild(th);
        });
        const actionTh = document.createElement('th');
        actionTh.className = 'px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider';
        actionTh.textContent = '操作';
        headerRow.appendChild(actionTh);
        tableHeader.appendChild(headerRow);
    }

    products.forEach((product) => {
        const row = document.createElement('tr');

        if (isMobile) {
            // === 移动端两列卡片 ===
            const brand = product['品牌'] || '';
            const category = product['小类'] || '';
            const model = product['产品型号'] || '';
            const price1 = product['开单价'] ? `¥${product['开单价']}` : '';
            const price2 = product['代发价'] ? `¥${product['代发价']}` : '';
            const price3 = product['零售价'] ? `¥${product['零售价']}` : '';
            const stock = product['库存'] || '';

            row.innerHTML = `
    		<td><strong>品牌:</strong> ${brand}</td>
    		<td><strong>小类:</strong> ${category}</td>
    		<td><strong>型号:</strong> ${model}</td>
    		<td><strong>开单价:</strong> ${price1}</td>
    		<td><strong>代发价:</strong> ${price2}</td>
    		<td><strong>零售价:</strong> ${price3}</td>
    		<td><strong>库存:</strong> ${stock}</td>
    		<td>
        		<div class="card-actions">
            		<button data-image-url="${product['产品缩略图URL'] || ''}" class="btn-action btn-image view-image-btn">看图片</button>
            		<button data-id="${product['序号']}" class="btn-action btn-details view-details-btn">看详情</button>
        		</div>
    		</td>
		`;
        } else {
            // === 桌面端表格 ===
            displayColumns.forEach(colName => {
                const td = document.createElement('td');
                td.className = 'px-4 py-4 text-sm text-slate-600 break-words';
                const cellValue = product[colName] || '';
                td.textContent = ['开单价','代发价','零售价'].includes(colName) && cellValue ? `¥${cellValue}` : cellValue;
                row.appendChild(td);
            });

            const actionTd = document.createElement('td');
		actionTd.className = 'px-4 py-4 whitespace-nowrap text-sm text-center';
		actionTd.innerHTML = `
    		<!-- 使用flex-col类实现垂直布局 -->
    		<div class="flex flex-col items-center gap-2">
        		<button data-image-url="${product['产品缩略图URL'] || ''}" class="btn-action btn-image view-image-btn w-full">看图片</button>
        		<button data-id="${product['序号']}" class="btn-action btn-details view-details-btn w-full">看详情</button>
    		</div>
		`;
		row.appendChild(actionTd);

        }

        tableBody.appendChild(row);
    });

    statsDiv.textContent = `查询到 ${products.length} 条相关记录。`;
}

        
        function showProductDetails(product) {
            modalTitle.textContent = `${product['品牌'] || ''} - ${product['产品型号'] || '产品详情'}`;
            let detailsHtml = '<dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">';

            const createDetailItem = (key, value) => {
                if (value === null || value === undefined || value === '') return '';
                
                const valueStr = String(value);
                let valueHtml;

                if (LONG_TEXT_FIELDS.includes(key)) {
                    valueHtml = `
                        <div class="relative">
                            <p class="text-sm text-gray-900 break-all line-clamp-2">${valueStr}</p>
                            <button class="toggle-clamp-btn text-xs text-sky-600 font-semibold mt-1 hover:underline">展开</button>
                        </div>`;
                } else if (URL_FIELDS.includes(key)) {
                    const buttonText = key.includes('URL') ? '看图片' : (key.includes('资料包') ? '下载资料包' : '打开链接');
                    valueHtml = `
                        <div class="flex items-center space-x-2 mt-1">
                            <a href="${valueStr}" target="_blank" rel="noopener noreferrer" 
                               class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>
                                ${buttonText}
                            </a>
                            <button data-url="${valueStr}" 
                               class="copy-url-btn inline-flex items-center p-2 border border-slate-300 text-xs font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500" title="复制链接">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                        </div>`;
                } else {
                    valueHtml = `<span class="text-sm text-gray-900 break-all">${valueStr}</span>`;
                }

                return `<div class="bg-slate-50 p-3 rounded-lg flex flex-col"><dt class="text-sm font-medium text-gray-500">${key}</dt><dd class="mt-1">${valueHtml}</dd></div>`;
            };

            DB_COLUMN_ORDER.forEach(key => {
                if (product.hasOwnProperty(key)) {
                    detailsHtml += createDetailItem(key, product[key]);
                }
            });

            detailsHtml += '</dl>';
            modalBody.innerHTML = detailsHtml;
            productModal.classList.remove('opacity-0', 'pointer-events-none');
            productModal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function hideProductDetails() {
            productModal.classList.add('opacity-0', 'pointer-events-none');
            productModal.querySelector('.modal-content').classList.add('scale-95');
        }

        function showImageModal(imageUrl) {
            modalImage.src = imageUrl;
            imageModal.classList.remove('opacity-0', 'pointer-events-none');
        }

        function hideImageModal() {
            imageModal.classList.add('opacity-0', 'pointer-events-none');
            modalImage.src = '';
        }

        function escapeCSVCell(cell) {
            if (cell === null || cell === undefined) return '';
            const cellStr = String(cell);
            if (cellStr.search(/("|,|\n)/g) >= 0) {
                return `"${cellStr.replace(/"/g, '""')}"`;
            }
            return cellStr;
        }
        
        function showCopyToast() {
            copyToast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                copyToast.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showCopyToast();
            } catch (err) {
                console.error('无法复制链接: ', err);
            }
            document.body.removeChild(textArea);
        }

        // --- 事件监听器设置 ---
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') performSearch(); });
        exportButton.addEventListener('click', exportToCSV);
        closeModalButton.addEventListener('click', hideProductDetails);
        productModal.addEventListener('click', (event) => { if (event.target === productModal) hideProductDetails(); });
        closeImageModalButton.addEventListener('click', hideImageModal);
        imageModal.addEventListener('click', (event) => { if (event.target === imageModal) hideImageModal(); });
        sortButton.addEventListener('click', handleSort);

        tableBody.addEventListener('click', (event) => {
            const detailsButton = event.target.closest('.view-details-btn');
            if (detailsButton) {
                event.preventDefault();
                const id = detailsButton.dataset.id;
                fetchAndShowDetails(id);
                return;
            }
            const imageButton = event.target.closest('.view-image-btn');
            if (imageButton) {
                event.preventDefault();
                const imageUrl = imageButton.dataset.imageUrl;
                showImageModal(imageUrl);
            }
        });
        
        modalBody.addEventListener('click', function(event) {
            const toggleBtn = event.target.closest('.toggle-clamp-btn');
            if (toggleBtn) {
                const p = toggleBtn.previousElementSibling;
                p.classList.toggle('line-clamp-2');
                toggleBtn.textContent = p.classList.contains('line-clamp-2') ? '展开' : '收起';
            }

            const copyBtn = event.target.closest('.copy-url-btn');
            if (copyBtn) {
                const url = copyBtn.dataset.url;
                copyToClipboard(url);
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('authToken')) {
                showApp();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
